<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EPUB Web Reader - Production Ready</title>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .epub-container { height: calc(100vh - 120px); }
    .toc-item { transition: all 0.2s ease; }
    .toc-item:hover { background-color: rgba(59, 130, 246, 0.1); }
    .search-highlight { background-color: #fef08a; padding: 2px 4px; border-radius: 2px; }
    .bookmark-indicator { position: absolute; top: 10px; right: 10px; color: #f59e0b; font-size: 24px; }
    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg) } to { transform: rotate(360deg) } }
    .theme-dark { background: #1f2937; color: #f9fafb; }
    .theme-dark .bg-white { background: #374151 !important; }
    .theme-dark .text-gray-900 { color: #f9fafb !important; }
    .theme-dark .border-gray-200 { border-color: #4b5563 !important; }
    .reader-content { line-height: var(--line-height, 1.6); font-size: var(--font-size, 16px); }
  </style>
</head>
<body class="bg-gray-50 transition-colors duration-200">
  <!-- Navigation Header -->
  <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-4">
          <h1 class="text-xl font-semibold text-gray-900">EPUB Reader</h1>
          <div id="book-info" class="hidden">
            <span class="text-sm text-gray-600" id="book-title"></span>
            <span class="text-xs text-gray-400 ml-2" id="book-author"></span>
          </div>
        </div>
        <div class="flex items-center space-x-3">
          <button id="search-btn" class="p-2 text-gray-600 hover:text-gray-900 rounded-md hover:bg-gray-100" title="Search (f)">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          </button>
          <button id="bookmark-btn" class="p-2 text-gray-600 hover:text-gray-900 rounded-md hover:bg-gray-100" title="Bookmark (b)">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
          </button>
          <button id="toc-btn" class="p-2 text-gray-600 hover:text-gray-900 rounded-md hover:bg-gray-100" title="Table of Contents">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
          </button>
          <button id="settings-btn" class="p-2 text-gray-600 hover:text-gray-900 rounded-md hover:bg-gray-100" title="Settings">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </button>
          <button id="library-btn" class="px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Library</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="flex h-screen">
    <!-- Library View -->
    <div id="library-view" class="w-full">
      <div class="max-w-6xl mx-auto px-4 py-8">
        <div class="mb-8">
          <h2 class="text-3xl font-bold text-gray-900 mb-2">Your Library</h2>
          <p class="text-gray-600">Select a book to start reading</p>
        </div>
        <div id="books-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
      </div>
    </div>

    <!-- Reader View -->
    <div id="reader-view" class="hidden w-full flex">
      <!-- Sidebar (TOC) -->
      <div id="sidebar" class="hidden w-80 bg-white border-r border-gray-200 flex-shrink-0 overflow-y-auto">
        <div class="p-4 border-b border-gray-200">
          <h3 class="font-semibold text-gray-900 mb-2">Table of Contents</h3>
          <div class="relative">
            <input id="toc-search" type="text" placeholder="Search chapters..."
                   class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
          </div>
        </div>
        <div id="toc-list" class="p-2" role="tree" aria-label="Table of Contents"></div>
      </div>

      <!-- Reader -->
      <div class="flex-1 flex flex-col">
        <!-- Controls -->
        <div class="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <button id="prev-btn" class="p-2 text-gray-600 hover:text-gray-900 rounded-md hover:bg-gray-100 disabled:opacity-50" title="Previous (â†)">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </button>
            <button id="next-btn" class="p-2 text-gray-600 hover:text-gray-900 rounded-md hover:bg-gray-100 disabled:opacity-50" title="Next (â†’)">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            </button>
            <div class="text-sm text-gray-600" id="location-info">
              <span id="current-chapter">Chapter 1</span>
              <span class="mx-2">â€¢</span>
              <span id="progress-text">0%</span>
            </div>
          </div>

          <!-- Progress -->
          <div class="flex-1 mx-8">
            <input id="progress-slider" type="range" min="0" max="100" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"/>
          </div>

          <div class="flex items-center space-x-2">
            <button id="view-mode-btn" class="px-3 py-1 text-xs font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Paginated</button>
          </div>
        </div>

        <!-- Viewer -->
        <div class="flex-1 relative bg-white">
          <div id="loading" class="absolute inset-0 flex items-center justify-center bg-white z-10">
            <div class="text-center">
              <div class="loading-spinner w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
              <p class="text-gray-600">Loading book...</p>
            </div>
          </div>
          <div id="viewer" class="epub-container w-full h-full"></div>
          <div id="bookmark-indicator" class="bookmark-indicator hidden">ðŸ“–</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search Modal -->
  <div id="search-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-start justify-center pt-20">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4">
      <div class="p-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-900">Search Book</h3>
          <button id="close-search" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <input id="search-input" type="text" placeholder="Search for text..."
               class="w-full mt-3 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"/>
      </div>
      <div id="search-results" class="max-h-96 overflow-y-auto">
        <div class="p-4 text-center text-gray-500">Enter search terms to find content in the book</div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
      <div class="p-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-900">Reading Settings</h3>
          <button id="close-settings" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
      </div>
      <div class="p-4 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Theme</label>
          <select id="theme-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
            <option value="auto">Auto</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Font Size</label>
          <input id="font-size-slider" type="range" min="12" max="24" value="16" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"/>
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <span>12px</span><span id="font-size-value">16px</span><span>24px</span>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Line Height</label>
          <input id="line-height-slider" type="range" min="1.2" max="2.0" step="0.1" value="1.6" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"/>
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <span>1.2</span><span id="line-height-value">1.6</span><span>2.0</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bookmarks Modal -->
  <div id="bookmarks-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
      <div class="p-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold text-gray-900">Bookmarks</h3>
          <button id="close-bookmarks" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
      </div>
      <div id="bookmarks-list" class="max-h-96 overflow-y-auto p-4">
        <div class="text-center text-gray-500">No bookmarks yet</div>
      </div>
    </div>
  </div>

  <script>
    // Root GitHub Pages site
    const BASE = '/';

    class EPUBReader {
      constructor() {
        this.book = null;
        this.rendition = null;
        this.currentLocation = null;

        this.bookmarks = new Map();
        this.searchIndex = new Map();

        this.currentBookId = null;
        this.viewMode = 'paginated'; // or 'scrolled'
        this.theme = 'light';
        this.fontSize = 16;
        this.lineHeight = 1.6;

        this.booksData = [];
        this.loadBooks();  // << required

        this.init();
      }

      // -------- lifecycle -------
      init() {
        this.setupEventListeners();
        this.loadSettings();
        this.showLibrary();
        this.handleDeepLinks();
      }

      async loadBooks() {
        try {
          const res = await fetch(`${BASE}books.json`, { cache: 'no-store' });
          this.booksData = await res.json();
          // If we're on library view, render now
          if (!document.getElementById('reader-view').classList.contains('hidden')) return;
          this.renderLibrary();
        } catch (e) {
          console.error('Failed to load books.json', e);
        }
      }

      // -------- UI wiring -------
      setupEventListeners() {
        // Nav
        document.getElementById('library-btn').addEventListener('click', () => this.showLibrary());
        document.getElementById('prev-btn').addEventListener('click', () => this.prevPage());
        document.getElementById('next-btn').addEventListener('click', () => this.nextPage());
        document.getElementById('toc-btn').addEventListener('click', () => this.toggleSidebar());

        // Search
        document.getElementById('search-btn').addEventListener('click', () => this.openSearchModal());
        document.getElementById('close-search').addEventListener('click', () => this.closeSearchModal());
        document.getElementById('search-input').addEventListener('input', (e) => this.performSearch(e.target.value));

        // Bookmarks
        document.getElementById('bookmark-btn').addEventListener('click', () => this.toggleBookmark());
        document.getElementById('close-bookmarks').addEventListener('click', () => this.closeBookmarksModal());

        // Settings
        document.getElementById('settings-btn').addEventListener('click', () => this.openSettingsModal());
        document.getElementById('close-settings').addEventListener('click', () => this.closeSettingsModal());
        document.getElementById('theme-select').addEventListener('change', (e) => this.setTheme(e.target.value));
        document.getElementById('font-size-slider').addEventListener('input', (e) => this.setFontSize(e.target.value));
        document.getElementById('line-height-slider').addEventListener('input', (e) => this.setLineHeight(e.target.value));

        // View mode
        document.getElementById('view-mode-btn').addEventListener('click', () => this.toggleViewMode());

        // Progress
        document.getElementById('progress-slider').addEventListener('input', (e) => this.goToProgress(e.target.value));

        // Keyboard
        document.addEventListener('keydown', (e) => this.handleKeyboard(e));

        // TOC search
        document.getElementById('toc-search').addEventListener('input', (e) => this.filterTOC(e.target.value));

        // Modals close on backdrop
        document.getElementById('search-modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) this.closeSearchModal(); });
        document.getElementById('settings-modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) this.closeSettingsModal(); });
        document.getElementById('bookmarks-modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) this.closeBookmarksModal(); });
      }

      // -------- views ----------
      showLibrary() {
        document.getElementById('library-view').classList.remove('hidden');
        document.getElementById('reader-view').classList.add('hidden');
        document.getElementById('book-info').classList.add('hidden');
        this.renderLibrary();
        this.updateURL('library');
      }

      renderLibrary() {
        const grid = document.getElementById('books-grid');
        grid.innerHTML = this.booksData.map(book => {
          const coverSrc = book.cover && book.cover.trim() ? book.cover : `${BASE}covers/arabiyya.svg`;
          return `
            <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow cursor-pointer book-card" data-book-id="${book.id}">
              <div class="w-full h-48 overflow-hidden bg-gray-100">
                <img src="${coverSrc}" alt="${book.title} cover" class="w-full h-full object-cover"/>
              </div>
              <div class="p-4">
                <h3 class="font-semibold text-gray-900 mb-1 line-clamp-2">${book.title}</h3>
                <p class="text-sm text-gray-600 mb-2">${book.author}</p>
                <p class="text-xs text-gray-500 line-clamp-3">${book.description}</p>
              </div>
            </div>`;
        }).join('');

        grid.querySelectorAll('.book-card').forEach(card => {
          card.addEventListener('click', () => this.openBook(card.dataset.bookId));
        });
      }

      async openBook(bookId, location = null) {
        const bookData = this.booksData.find(b => b.id === bookId);
        if (!bookData) return;

        this.currentBookId = bookId;
        this.showReader();
        this.showLoading();

        try {
          this.book = ePub(`${BASE}${bookData.href}`);

          const viewer = document.getElementById('viewer');
          viewer.innerHTML = '';

          this.rendition = this.book.renderTo(viewer, {
            width: '100%', height: '100%',
            spread: this.viewMode === 'paginated' ? 'auto' : 'none',
            flow: this.viewMode === 'scrolled' ? 'scrolled' : 'paginated'
          });

          this.applyReaderSettings();

          await this.book.ready;
          if (!this.book.locations || this.book.locations.length() === 0) {
            await this.book.locations.generate(1600);
          }

          const startLoc = location || this.getLastLocation(bookId) || undefined;
          await this.rendition.display(startLoc);

          this.setupBookEventHandlers();
          await this.loadBookMetadata();

          this.hideLoading();
          this.updateBookInfo(bookData);
          this.loadBookmarks(bookId);
        } catch (error) {
          console.error('Error loading book:', error);
          this.hideLoading();
          this.showError('Failed to load book. Please try again.');
        }
      }

      showReader() {
        document.getElementById('library-view').classList.add('hidden');
        document.getElementById('reader-view').classList.remove('hidden');
        document.getElementById('book-info').classList.remove('hidden');
      }

      showLoading() { document.getElementById('loading').classList.remove('hidden'); }
      hideLoading() { document.getElementById('loading').classList.add('hidden'); }

      setupBookEventHandlers() {
        this.rendition.on('relocated', (location) => {
          this.currentLocation = location;
          this.updateProgress();
          this.saveLastLocation();
          this.updateURL(`read/${this.currentBookId}?loc=${location.start.cfi}`);
        });

        this.rendition.on('selected', (cfiRange, contents) => {
          // hook for future annotations
        });
      }

      async loadBookMetadata() {
        try {
          const metadata = await this.book.loaded.metadata;
          const navigation = await this.book.loaded.navigation;
          this.renderTOC(navigation.toc);
          // could also surface metadata.title/creator if needed
        } catch (err) {
          console.error('Error loading metadata:', err);
        }
      }

      renderTOC(tocItems) {
        const tocList = document.getElementById('toc-list');
        tocList.innerHTML = tocItems.map(item => `
          <div class="toc-item p-2 rounded cursor-pointer hover:bg-blue-50" data-href="${item.href}" role="treeitem" tabindex="0">
            <div class="font-medium text-sm text-gray-900">${item.label}</div>
          </div>`).join('');

        tocList.querySelectorAll('.toc-item').forEach(item => {
          item.addEventListener('click', () => { this.rendition.display(item.dataset.href); this.hideSidebar(); });
          item.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); item.click(); } });
        });
      }

      updateBookInfo(bookData) {
        document.getElementById('book-title').textContent = bookData.title;
        document.getElementById('book-author').textContent = `by ${bookData.author}`;
        document.title = `${bookData.title} - EPUB Reader`;
        this.updateMetaTags(bookData);
      }

      updateMetaTags(bookData) {
        const updateMeta = (property, content) => {
          let meta = document.querySelector(`meta[property="${property}"]`);
          if (!meta) { meta = document.createElement('meta'); meta.setAttribute('property', property); document.head.appendChild(meta); }
          meta.setAttribute('content', content);
        };
        updateMeta('og:title', bookData.title);
        updateMeta('og:description', bookData.description);
        updateMeta('og:image', bookData.cover || '');
        updateMeta('og:type', 'book');
      }

      // -------- navigation/progress -------
      prevPage() { if (this.rendition) this.rendition.prev(); }
      nextPage() { if (this.rendition) this.rendition.next(); }

      goToProgress(percentage) {
        if (this.book && this.rendition && this.book.locations) {
          const cfi = this.book.locations.cfiFromPercentage(percentage / 100);
          if (cfi) this.rendition.display(cfi);
        }
      }

      updateProgress() {
        if (!this.currentLocation) return;
        const progress = Math.round(this.currentLocation.start.percentage * 100);
        document.getElementById('progress-slider').value = progress;
        document.getElementById('progress-text').textContent = `${progress}%`;
        document.getElementById('current-chapter').textContent = this.getCurrentChapterInfo();
      }

      getCurrentChapterInfo() {
        // Could parse from spine or nav landmarks; placeholder for now.
        return 'Chapter';
      }

      // -------- search (mock) ----------
      openSearchModal() {
        document.getElementById('search-modal').classList.remove('hidden');
        document.getElementById('search-input').focus();
      }
      closeSearchModal() {
        document.getElementById('search-modal').classList.add('hidden');
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').innerHTML = '<div class="p-4 text-center text-gray-500">Enter search terms to find content in the book</div>';
      }
      async performSearch(query) {
        if (!query.trim() || !this.book) return;
        const resultsContainer = document.getElementById('search-results');
        resultsContainer.innerHTML = '<div class="p-4 text-center"><div class="loading-spinner w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full mx-auto"></div></div>';

        // Placeholder search results (wire real indexing later)
        const mockResults = [
          { cfi: '/6/4[chapter01]!/4/2/2/2', excerpt: `Example with <mark>${query}</mark> highlighted.`, chapter: 'Chapter 1' }
        ];
        resultsContainer.innerHTML = mockResults.map(r => `
          <div class="border-b border-gray-200 p-4 hover:bg-gray-50 cursor-pointer search-result" data-cfi="${r.cfi}">
            <div class="text-sm font-medium text-gray-900 mb-1">${r.chapter}</div>
            <div class="text-sm text-gray-700">${r.excerpt}</div>
          </div>`).join('');
        resultsContainer.querySelectorAll('.search-result').forEach(el => {
          el.addEventListener('click', () => { this.rendition.display(el.dataset.cfi); this.closeSearchModal(); });
        });
      }

      // -------- bookmarks ----------
      toggleBookmark() {
        if (!this.currentLocation || !this.currentBookId) return;
        const key = `${this.currentBookId}-${this.currentLocation.start.cfi}`;
        const bookmarks = this.getBookmarks(this.currentBookId);
        if (bookmarks.has(key)) { bookmarks.delete(key); this.hideBookmarkIndicator(); }
        else {
          bookmarks.set(key, {
            cfi: this.currentLocation.start.cfi,
            chapter: this.getCurrentChapterInfo(),
            timestamp: new Date().toISOString(),
            excerpt: this.getLocationExcerpt()
          });
          this.showBookmarkIndicator();
        }
        this.saveBookmarks(this.currentBookId, bookmarks);
      }
      getBookmarks(bookId) {
        if (!this.bookmarks.has(bookId)) {
          const saved = localStorage.getItem(`bookmarks-${bookId}`);
          const map = new Map();
          if (saved) Object.entries(JSON.parse(saved)).forEach(([k, v]) => map.set(k, v));
          this.bookmarks.set(bookId, map);
        }
        return this.bookmarks.get(bookId);
      }
      saveBookmarks(bookId, map) {
        const obj = {}; map.forEach((v, k) => obj[k] = v);
        localStorage.setItem(`bookmarks-${bookId}`, JSON.stringify(obj));
      }
      loadBookmarks(bookId) {
        const bookmarks = this.getBookmarks(bookId);
        if (this.currentLocation) {
          const key = `${bookId}-${this.currentLocation.start.cfi}`;
          if (bookmarks.has(key)) this.showBookmarkIndicator();
        }
      }
      showBookmarkIndicator() { document.getElementById('bookmark-indicator').classList.remove('hidden'); }
      hideBookmarkIndicator() { document.getElementById('bookmark-indicator').classList.add('hidden'); }
      getLocationExcerpt() { return 'Sample excerpt from current location...'; }
      closeBookmarksModal() { document.getElementById('bookmarks-modal').classList.add('hidden'); }

      // -------- settings/theme ----------
      openSettingsModal() { document.getElementById('settings-modal').classList.remove('hidden'); this.updateSettingsUI(); }
      closeSettingsModal() { document.getElementById('settings-modal').classList.add('hidden'); }
      updateSettingsUI() {
        document.getElementById('theme-select').value = this.theme;
        document.getElementById('font-size-slider').value = this.fontSize;
        document.getElementById('line-height-slider').value = this.lineHeight;
        document.getElementById('font-size-value').textContent = `${this.fontSize}px`;
        document.getElementById('line-height-value').textContent = this.lineHeight;
      }
      setTheme(theme) { this.theme = theme; this.applyTheme(); this.saveSettings(); }
      setFontSize(size) { this.fontSize = parseInt(size); document.getElementById('font-size-value').textContent = `${this.fontSize}px`; this.applyReaderSettings(); this.saveSettings(); }
      setLineHeight(height) { this.lineHeight = parseFloat(height); document.getElementById('line-height-value').textContent = this.lineHeight; this.applyReaderSettings(); this.saveSettings(); }

      applyTheme() {
        const isDark = this.theme === 'dark' || (this.theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
        document.body.classList.toggle('theme-dark', isDark);
      }
      applyReaderSettings() {
        if (this.rendition) {
          const isDark = document.body.classList.contains('theme-dark');
          this.rendition.themes.register('custom', {
            'body': {
              'font-size': `${this.fontSize}px !important`,
              'line-height': `${this.lineHeight} !important`,
              'background': isDark ? '#1f2937 !important' : '#ffffff !important',
              'color': isDark ? '#f9fafb !important' : '#111827 !important'
            }
          });
          this.rendition.themes.select('custom');
        }
        document.documentElement.style.setProperty('--font-size', `${this.fontSize}px`);
        document.documentElement.style.setProperty('--line-height', this.lineHeight);
      }
      toggleViewMode() {
        this.viewMode = this.viewMode === 'paginated' ? 'scrolled' : 'paginated';
        document.getElementById('view-mode-btn').textContent = this.viewMode === 'paginated' ? 'Paginated' : 'Scrolled';
        if (this.rendition) {
          const loc = this.currentLocation?.start?.cfi;
          this.openBook(this.currentBookId, loc);
        }
        this.saveSettings();
      }

      // -------- sidebar ----------
      toggleSidebar() { document.getElementById('sidebar').classList.toggle('hidden'); }
      hideSidebar() { document.getElementById('sidebar').classList.add('hidden'); }
      filterTOC(query) {
        const items = document.querySelectorAll('.toc-item');
        items.forEach(item => { item.style.display = item.textContent.toLowerCase().includes(query.toLowerCase()) ? 'block' : 'none'; });
      }

      // -------- keyboard ----------
      handleKeyboard(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        switch (e.key) {
          case 'ArrowLeft': e.preventDefault(); this.prevPage(); break;
          case 'ArrowRight': e.preventDefault(); this.nextPage(); break;
          case 'f': case 'F': if (!e.ctrlKey && !e.metaKey) { e.preventDefault(); this.openSearchModal(); } break;
          case 'b': case 'B': if (!e.ctrlKey && !e.metaKey) { e.preventDefault(); this.toggleBookmark(); } break;
          case 'Escape': this.closeAllModals(); break;
        }
      }
      closeAllModals() { this.closeSearchModal(); this.closeSettingsModal(); this.closeBookmarksModal(); }

      // -------- persistence ----------
      saveLastLocation() { if (this.currentLocation && this.currentBookId) localStorage.setItem(`lastLocation-${this.currentBookId}`, this.currentLocation.start.cfi); }
      getLastLocation(bookId) { return localStorage.getItem(`lastLocation-${bookId}`); }
      saveSettings() { localStorage.setItem('readerSettings', JSON.stringify({ theme: this.theme, fontSize: this.fontSize, lineHeight: this.lineHeight, viewMode: this.viewMode })); }
      loadSettings() {
        const saved = localStorage.getItem('readerSettings');
        if (saved) {
          const s = JSON.parse(saved);
          this.theme = s.theme || 'light';
          this.fontSize = s.fontSize || 16;
          this.lineHeight = s.lineHeight || 1.6;
          this.viewMode = s.viewMode || 'paginated';
        }
        this.applyTheme();
      }

      // -------- routing ----------
