<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta id="theme-color-meta" name="theme-color" content="#ffffff" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600;700&display=swap" rel="stylesheet">
  <title>big spoon society</title>

  <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"></script>

  <style>
    :root {
      --bg: #f7f7f8;
      --card: #ffffff;
      --text: #111;
      --muted: #666;
      --brand: #2563eb;
      --brand-2: #1d4ed8;
      --ring: rgba(37, 99, 235, 0.2);
    }
    
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; 
      background: var(--bg); 
      color: var(--text);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }

    /* Navigation */
    .nav {
      position: sticky; 
      top: 0; 
      z-index: 10;
      background: var(--card); 
      border-bottom: 1px solid #e5e7eb;
    }
    .nav-inner { 
      max-width: 1100px; 
      margin: 0 auto; 
      padding: 12px 24px; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
    }
    .brand { 
      font: 700 20px/1.2 "Fredoka", system-ui; 
      text-transform: lowercase; 
      letter-spacing: .2px; 
    }

    /* Library view */
    .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .btn {
      appearance: none; 
      border: 1px solid #e5e7eb; 
      background: #fff; 
      color: #111;
      border-radius: 8px; 
      padding: 8px 12px; 
      cursor: pointer;
      min-width: 44px;
      min-height: 44px;
    }
    .btn.brand { background: var(--brand); border-color: var(--brand); color: #fff; }
    .btn.brand:hover { background: var(--brand-2); }
    .grid {
      display: grid; 
      gap: 16px;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    }
    .card {
      background: var(--card); 
      border: 1px solid #e5e7eb; 
      border-radius: 12px; 
      overflow: hidden;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
      cursor: pointer; 
      transition: transform .06s ease, box-shadow .06s ease;
    }
    .card:hover { 
      transform: translateY(-1px); 
      box-shadow: 0 4px 10px rgba(0,0,0,.06); 
    }
    .cover { 
      aspect-ratio: 16/10; 
      width: 100%; 
      object-fit: cover; 
      display: block; 
      background: #f3f4f6; 
    }
    .card-body { padding: 12px 14px 16px; }
    .title { font-weight: 650; margin: 4px 0 6px; }
    .by { color: var(--muted); font-size: 14px; margin-bottom: 6px; }
    .desc { 
      color: #444; 
      font-size: 14px; 
      display: -webkit-box; 
      -webkit-line-clamp: 3; 
      -webkit-box-orient: vertical; 
      overflow: hidden; 
    }

    /* Reader layout - SIMPLIFIED: No grid, just full-width viewer */
    #reader-view { 
      display: none; 
      height: calc(100vh - 52px);
      position: relative;
    }
    #reader-view.show { 
      display: block; 
    }

    /* Main reader area - always full width */
    #stage { 
      position: relative; 
      background: var(--card); 
      height: 100%;
      width: 100%;
    }
    #viewer { 
      width: 100%; 
      height: calc(100% - 60px); /* Account for toolbar */
      position: relative;
    }

    /* Toolbar */
    .toolbar {
      display: flex; 
      align-items: center; 
      gap: 8px; 
      padding: 10px 12px; 
      border-bottom: 1px solid #e5e7eb; 
      background: var(--card);
      position: relative;
      z-index: 5;
      flex-wrap: wrap;
    }
    .grow { flex: 1; }
    .range { width: 100%; }
    .muted { color: var(--muted); font-size: 14px; }

    /* TOC Overlay System - Professional Implementation */
    #toc-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    #toc-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    #toc-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 320px;
      max-width: 80vw;
      height: 100%;
      background: var(--card);
      border-right: 1px solid #e5e7eb;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 101;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    }

    #toc-panel.show {
      transform: translateX(0);
    }

    #toc-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      background: var(--card);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    #toc-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }

    #toc-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--muted);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }

    #toc-close:hover {
      background: #f3f4f6;
      color: var(--text);
    }

    #toc-items {
      padding: 8px 0;
    }

    .toc-item {
      display: block;
      padding: 12px 20px;
      color: var(--text);
      text-decoration: none;
      border-left: 3px solid transparent;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .toc-item:hover {
      background: #f8fafc;
      border-left-color: var(--brand);
    }

    .toc-item.active {
      background: #eff6ff;
      border-left-color: var(--brand);
      color: var(--brand);
      font-weight: 500;
    }

    .toc-item-title {
      font-size: 14px;
      line-height: 1.4;
    }

    /* Loading */
    .loading {
      position: absolute; 
      inset: 0; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: var(--card);
      z-index: 2;
    }
    #loading[hidden] { display: none !important; }
    .spinner {
      width: 36px; 
      height: 36px; 
      border-radius: 50%; 
      border: 4px solid var(--brand); 
      border-top-color: transparent; 
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .toolbar {
        gap: 6px;
        padding: 8px 10px;
      }
      
      .toolbar .btn {
        min-width: 36px;
        min-height: 36px;
        padding: 6px 8px;
        font-size: 14px;
      }
      
      .grow {
        flex: 1 1 100%;
        order: 3;
        margin-top: 8px;
      }
      
      #toc-panel {
        width: 280px;
      }
    }

    /* Viewer iframe styling */
    #viewer iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
      border: 0;
      display: block;
    }

    /* Safe area handling */
    @supports(padding: env(safe-area-inset-top)) {
      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }
    }

    /* Screen reader only */
    .sr { 
      position: absolute; 
      width: 1px; 
      height: 1px; 
      padding: 0; 
      margin: -1px; 
      overflow: hidden; 
      clip: rect(0,0,0,0); 
      white-space: nowrap; 
      border: 0; 
    }
  </style>
</head>
<body>

  <!-- Top navigation -->
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">big spoon society</div>
      <div>
        <button id="to-library" class="btn">Library</button>
      </div>
    </div>
  </div>

  <!-- Library view -->
  <div id="library-view" class="wrap">
    <h1 style="margin: 0 0 12px;">Your Library</h1>
    <p class="muted" style="margin-top:0;">Select a book to start reading.</p>
    <div id="books-grid" class="grid" aria-live="polite"></div>
  </div>

  <!-- Reader view -->
  <div id="reader-view">
    <main id="stage">
      <div class="toolbar">
        <button id="prev" class="btn" title="Previous (←)">◀</button>
        <button id="next" class="btn" title="Next (→)">▶</button>
        <button id="flow-toggle" class="btn" title="Toggle pagination/scroll">↕︎</button>
        <button id="theme-toggle" class="btn" title="Change theme">◑</button>
        <button id="font-dec" class="btn" title="Decrease font size">A−</button>
        <button id="font-inc" class="btn" title="Increase font size">A+</button>
        <button id="line-height-toggle" class="btn" title="Adjust line height">ℓ</button>
        <button id="toc-toggle" class="btn" title="Table of contents">☰</button>
        <div id="chapter" class="muted" style="min-width:140px;"></div>
        <div class="grow">
          <input id="progress" class="range" type="range" min="0" max="100" value="0" />
        </div>
        <div id="percent" class="muted" style="min-width:40px; text-align:right;">0%</div>
      </div>
      
      <div id="viewer" role="region" aria-label="Book content"></div>
      
      <div id="loading" class="loading" hidden>
        <div>
          <div class="spinner" aria-hidden="true"></div>
          <div class="muted" style="text-align:center; margin-top:10px;">Loading book…</div>
        </div>
      </div>
    </main>
  </div>

  <!-- TOC Overlay System -->
  <div id="toc-overlay" aria-hidden="true">
    <div id="toc-panel" role="dialog" aria-labelledby="toc-title">
      <div id="toc-header">
        <h3 id="toc-title">Table of Contents</h3>
        <button id="toc-close" aria-label="Close table of contents">×</button>
      </div>
      <div id="toc-items"></div>
    </div>
  </div>

  <script>
    const BASE = './';

    const app = {
      books: [],
      book: null,
      rendition: null,
      currentBookId: null,
      currentLocation: null,
      locationsReady: false,
      prefs: null,

      loadPrefs() {
        const saved = (() => {
          try { return JSON.parse(localStorage.getItem('reader-prefs-v1') || '{}'); } catch (e) { return {}; }
        })();
        const defaults = {};
        if (!saved.flow) {
          defaults.flow = (window.innerWidth < 768) ? 'scrolled-doc' : 'paginated';
        }
        if (!saved.theme) {
          defaults.theme = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
        }
        if (saved.fontSize == null) defaults.fontSize = 100;
        if (saved.lineHeight == null) defaults.lineHeight = 1.4;
        return Object.assign({ flow: 'paginated', theme: 'light', fontSize: 100, lineHeight: 1.4 }, defaults, saved);
      },

      savePrefs() {
        try { localStorage.setItem('reader-prefs-v1', JSON.stringify(this.prefs)); } catch (e) {}
      },

      applyPrefs() {
        if (!this.rendition) return;

        const prefs = this.prefs || {};
        const theme = prefs.theme ?? 'light';
        const fontSize = prefs.fontSize ?? 100;
        const lineHeight = prefs.lineHeight ?? 1.4;
        const flow = prefs.flow ?? 'paginated';

        let bg, text, link;
        if (theme === 'sepia') {
          bg = '#f4ecd8'; text = '#5b4636'; link = '#b16933';
        } else if (theme === 'dark') {
          bg = '#1e1e1e'; text = '#f5f5f5'; link = '#4f8bfa';
        } else {
          bg = '#ffffff'; text = '#111111'; link = '#2563eb';
        }

        const css = `
          html, body { background:${bg} !important; color:${text} !important; }
          a, a:link, a:visited { color:${link} !important; }
          p, div, li, blockquote, section, article, span { line-height:${lineHeight} !important; }
          img, svg, figure { max-width:100% !important; height:auto !important; }
          /* Force single column layout */
          html, body, * { 
            column-count: 1 !important; 
            columns: auto !important; 
            column-width: auto !important;
            -webkit-column-count: 1 !important;
            -webkit-columns: auto !important;
            -webkit-column-width: auto !important;
          }
        `;
        this.rendition.themes.register('custom', css);
        this.rendition.themes.select('custom');

        this.rendition.themes.fontSize(`${fontSize}%`);
        this.rendition.themes.override('line-height', `${lineHeight} !important`);

        // Always use single spread to prevent multi-column issues
        this.rendition.flow(flow);
        this.rendition.spread(false);
        
        document.body.classList.toggle('paginated', flow === 'paginated');

        // Update CSS variables for UI theme
        const root = document.documentElement.style;
        if (theme === 'sepia') {
          root.setProperty('--bg', '#f4ecd8');
          root.setProperty('--card', '#fbf1d0');
          root.setProperty('--text', '#5b4636');
          root.setProperty('--muted', '#8b715e');
          root.setProperty('--brand', '#c47a3f');
          root.setProperty('--brand-2', '#b16933');
        } else if (theme === 'dark') {
          root.setProperty('--bg', '#1e1e1e');
          root.setProperty('--card', '#2a2a2a');
          root.setProperty('--text', '#f5f5f5');
          root.setProperty('--muted', '#999999');
          root.setProperty('--brand', '#4f8bfa');
          root.setProperty('--brand-2', '#3b76d1');
        } else {
          root.setProperty('--bg', '#f7f7f8');
          root.setProperty('--card', '#ffffff');
          root.setProperty('--text', '#111111');
          root.setProperty('--muted', '#666666');
          root.setProperty('--brand', '#2563eb');
          root.setProperty('--brand-2', '#1d4ed8');
        }

        this.updateThemeColor();
      },

      updateThemeColor() {
        const meta = document.getElementById('theme-color-meta');
        if (!meta || !this.prefs) return;
        let color;
        if (this.prefs.theme === 'sepia') color = '#f4ecd8';
        else if (this.prefs.theme === 'dark') color = '#1e1e1e';
        else color = '#ffffff';
        meta.setAttribute('content', color);
      },

      // TOC Management
      showTOC() {
        const overlay = document.getElementById('toc-overlay');
        const panel = document.getElementById('toc-panel');
        
        overlay.classList.add('show');
        panel.classList.add('show');
        overlay.setAttribute('aria-hidden', 'false');
        
        // Focus management for accessibility
        const closeBtn = document.getElementById('toc-close');
        if (closeBtn) closeBtn.focus();
      },

      hideTOC() {
        const overlay = document.getElementById('toc-overlay');
        const panel = document.getElementById('toc-panel');
        
        overlay.classList.remove('show');
        panel.classList.remove('show');
        overlay.setAttribute('aria-hidden', 'true');
        
        // Return focus to TOC toggle button
        const tocToggle = document.getElementById('toc-toggle');
        if (tocToggle) tocToggle.focus();
      },

      toggleTOC() {
        const overlay = document.getElementById('toc-overlay');
        if (overlay.classList.contains('show')) {
          this.hideTOC();
        } else {
          this.showTOC();
        }
      },

      populateTOC() {
        if (!this.book || !this.book.navigation) return;
        
        const container = document.getElementById('toc-items');
        container.innerHTML = '';
        
        const toc = this.book.navigation.toc;
        
        toc.forEach((item, index) => {
          const tocItem = document.createElement('a');
          tocItem.className = 'toc-item';
          tocItem.href = '#';
          tocItem.setAttribute('data-href', item.href);
          
          const title = document.createElement('div');
          title.className = 'toc-item-title';
          title.textContent = item.label;
          
          tocItem.appendChild(title);
          
          tocItem.addEventListener('click', (e) => {
            e.preventDefault();
            this.navigateToTOCItem(item.href);
            this.hideTOC();
          });
          
          container.appendChild(tocItem);
        });
      },

      navigateToTOCItem(href) {
        if (this.rendition) {
          this.rendition.display(href);
        }
      },

      async boot() {
        // Set up navigation
        document.getElementById('to-library').addEventListener('click', () => this.routeTo('library'));
        document.getElementById('prev').addEventListener('click', () => this.rendition && this.rendition.prev());
        document.getElementById('next').addEventListener('click', () => this.rendition && this.rendition.next());
        document.getElementById('progress').addEventListener('input', e => this.seek(e.target.value));

        // Initialize preferences
        this.prefs = this.loadPrefs();

        // Control buttons
        document.getElementById('flow-toggle').addEventListener('click', () => {
          this.prefs.flow = (this.prefs.flow === 'paginated') ? 'scrolled-doc' : 'paginated';
          this.savePrefs();
          if (this.rendition) this.applyPrefs();
        });

        document.getElementById('theme-toggle').addEventListener('click', () => {
          const sequence = ['light','sepia','dark'];
          const idx = sequence.indexOf(this.prefs.theme);
          this.prefs.theme = sequence[(idx + 1) % sequence.length];
          this.savePrefs();
          if (this.rendition) this.applyPrefs();
        });

        document.getElementById('font-dec').addEventListener('click', () => {
          this.prefs.fontSize = Math.max(90, (this.prefs.fontSize || 100) - 10);
          this.savePrefs();
          if (this.rendition) this.applyPrefs();
        });

        document.getElementById('font-inc').addEventListener('click', () => {
          this.prefs.fontSize = Math.min(150, (this.prefs.fontSize || 100) + 10);
          this.savePrefs();
          if (this.rendition) this.applyPrefs();
        });

        document.getElementById('line-height-toggle').addEventListener('click', () => {
          const heights = [1.2, 1.4, 1.6, 1.8];
          const current = this.prefs.lineHeight || 1.4;
          const idx = heights.indexOf(current);
          this.prefs.lineHeight = heights[(idx + 1) % heights.length];
          this.savePrefs();
          if (this.rendition) this.applyPrefs();
        });

        // TOC controls
        document.getElementById('toc-toggle').addEventListener('click', () => this.toggleTOC());
        document.getElementById('toc-close').addEventListener('click', () => this.hideTOC());
        
        // Close TOC when clicking overlay
        document.getElementById('toc-overlay').addEventListener('click', (e) => {
          if (e.target === e.currentTarget) {
            this.hideTOC();
          }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            this.hideTOC();
          }
        });

        // Load books and set up library
        await this.loadBooks();
        this.renderLibrary();
        this.routeTo('library');
      },

      async loadBooks() {
        try {
          const response = await fetch(`${BASE}books.json`);
          this.books = await response.json();
        } catch (error) {
          console.error('Failed to load books:', error);
          this.books = [];
        }
      },

      renderLibrary() {
        const grid = document.getElementById('books-grid');
        grid.innerHTML = '';
        
        this.books.forEach(book => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <img src="${book.cover}" alt="${book.title} cover" class="cover" loading="lazy" />
            <div class="card-body">
              <div class="title">${book.title}</div>
              <div class="by">by ${book.author}</div>
              <div class="desc">${book.description}</div>
            </div>
          `;
          card.addEventListener('click', () => this.openBook(book.id));
          grid.appendChild(card);
        });
      },

      routeTo(view) {
        document.getElementById('library-view').style.display = view === 'library' ? 'block' : 'none';
        document.getElementById('reader-view').classList.toggle('show', view === 'reader');
      },

      async openBook(bookId) {
        const bookData = this.books.find(b => b.id === bookId);
        if (!bookData) return;

        this.currentBookId = bookId;
        this.routeTo('reader');
        
        const loading = document.getElementById('loading');
        loading.hidden = false;

        try {
          this.book = ePub(bookData.href);
          this.rendition = this.book.renderTo('viewer', {
            width: '100%',
            height: '100%',
            spread: 'none'
          });

          await this.rendition.display();
          this.applyPrefs();
          
          // Populate TOC after book loads
          await this.book.ready;
          this.populateTOC();

          // Set up location tracking
          this.rendition.on('relocated', (location) => {
            this.currentLocation = location;
            this.updateProgress();
            this.updateChapterDisplay();
          });

          // Generate locations for progress tracking
          await this.book.locations.generate(1024);
          this.locationsReady = true;
          this.updateProgress();

        } catch (error) {
          console.error('Failed to load book:', error);
        } finally {
          loading.hidden = true;
        }
      },

      seek(percentage) {
        if (!this.rendition || !this.locationsReady) return;
        const location = this.book.locations.cfiFromPercentage(percentage / 100);
        this.rendition.display(location);
      },

      updateProgress() {
        if (!this.currentLocation || !this.locationsReady) return;
        
        const percentage = this.book.locations.percentageFromCfi(this.currentLocation.start.cfi);
        const progress = Math.round(percentage * 100);
        
        document.getElementById('progress').value = progress;
        document.getElementById('percent').textContent = `${progress}%`;
      },

      updateChapterDisplay() {
        if (!this.currentLocation || !this.book.navigation) return;
        
        const toc = this.book.navigation.toc;
        let currentChapter = 'Unknown Chapter';
        
        // Find current chapter based on location
        for (let i = 0; i < toc.length; i++) {
          const item = toc[i];
          if (this.currentLocation.start.href.includes(item.href.split('#')[0])) {
            currentChapter = item.label;
            break;
          }
        }
        
        document.getElementById('chapter').textContent = currentChapter;
      }
    };

    // Initialize app when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => app.boot());
    } else {
      app.boot();
    }
  </script>
</body>
</html>

