<!doctype html>
<meta charset="utf-8" />
<title>Trejo Recipes</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --fg:#1a1a1a; --sub:#585858; --bg:#fff; --muted:#f6f6f6; --line:#e8e8e8; --accent:#7a5cff;
    --radius:12px; --pad:1rem; --shadow:0 1px 2px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  body{margin:0; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";}
  a{color:inherit}
  header{position:sticky; top:0; background:var(--bg); border-bottom:1px solid var(--line); z-index:2}
  .wrap{max-width:980px; margin:0 auto; padding:clamp(.75rem,2vw,1.25rem);}
  .topbar{display:flex; gap:.75rem; align-items:center; justify-content:space-between; flex-wrap:wrap}
  .title{font-weight:700; letter-spacing:.2px}
  .back a{color:var(--sub); text-decoration:none}
  .controls{display:flex; gap:.5rem; width:100%; margin-top:.5rem; flex-wrap:wrap}
  .search{flex:1; display:flex; align-items:center; gap:.5rem; background:var(--muted); padding:.625rem .75rem; border-radius:999px}
  .search input{border:0; outline:0; background:transparent; width:100%; font-size:1rem}
  .selects{display:flex; gap:.5rem; align-items:center}
  .chip{border:1px solid var(--line); padding:.4rem .65rem; border-radius:999px; background:#fff; cursor:pointer; user-select:none}
  .chip[aria-pressed="true"]{border-color:var(--accent); color:var(--accent)}
  main{padding-block:1rem}
  .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); gap:1rem}
  .card{display:flex; flex-direction:column; gap:.4rem; background:#fff; border:1px solid var(--line); border-radius:var(--radius); padding:var(--pad); box-shadow:var(--shadow)}
  .num{font-size:.8rem; color:var(--sub); background:var(--muted); padding:.2rem .5rem; border-radius:999px; width:max-content}
  .name{font-weight:600; margin-top:.1rem}
  .open{margin-top:auto; font-size:.9rem; color:var(--accent); text-decoration:none}
  .count{color:var(--sub); font-size:.9rem; margin:.75rem 0}
  .raw-list{display:none}
  noscript .raw-list{display:block; padding:1rem}
  noscript .raw-list li{margin:.25rem 0}
</style>

<header>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">Trejo Recipes</div>
        <div class="back"><a href="/">← Back to site</a></div>
      </div>
      <div class="controls">
        <label class="search" aria-label="Search recipes">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M15.8 14.4l4.6 4.6-1.4 1.4-4.6-4.6a7 7 0 1 1 1.4-1.4zM5 10a5 5 0 1 0 10 0A5 5 0 0 0 5 10z" fill="currentColor"/></svg>
          <input id="q" type="search" placeholder="Search by name or number…" autocomplete="off" />
        </label>
        <div class="selects" role="group" aria-label="Sort">
          <button class="chip" id="sort-num" aria-pressed="true">Sort: Number</button>
          <button class="chip" id="sort-az" aria-pressed="false">A–Z</button>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="count" id="count"></div>
  <div class="grid" id="grid" aria-live="polite"></div>

  <!-- Fallback (no JS or no JSON): your original list of links. -->
  <noscript>
    <ul class="raw-list">
      <!-- keep your generated <li><a href="exports/html/...">filename</a></li> list here as a fallback -->
    </ul>
  </noscript>
</main>

<script>
(function(){
  const grid = document.getElementById('grid');
  const count = document.getElementById('count');
  const q = document.getElementById('q');
  const sortNum = document.getElementById('sort-num');
  const sortAZ = document.getElementById('sort-az');

  // Utility: pull 3-digit number prefix from filename (e.g., "012-…")
  const numFromFile = (file) => (file.match(/^(\d{3})-/)||[])[1] || "";

  // Render
  function render(list){
    grid.innerHTML="";
    list.forEach(it=>{
      const card = document.createElement('article');
      card.className='card';

      const num = document.createElement('div');
      num.className='num';
      num.textContent = it.num ? `#${it.num}` : '—';

      const name = document.createElement('div');
      name.className='name';
      name.textContent = it.title;   // human title from JSON

      const open = document.createElement('a');
      open.className='open';
      open.href = it.href;           // keep existing link path
      open.textContent = 'Open →';

      card.append(num,name,open);
      grid.appendChild(card);
    });
    count.textContent = `${list.length} recipe${list.length===1?"":"s"}`;
  }

  function apply(){
    const term = (q.value||"").trim().toLowerCase();
    let list = items.filter(it=>{
      return !term
        || it.num.includes(term)
        || it.title.toLowerCase().includes(term);
    });
    if (sortAZ.getAttribute('aria-pressed') === 'true') {
      list.sort((a,b)=>a.title.localeCompare(b.title));
    } else {
      list.sort((a,b)=> (a.num||"").localeCompare(b.num||""));
    }
    render(list);
  }

  function toggle(on, off){
    on.setAttribute('aria-pressed','true');
    off.setAttribute('aria-pressed','false');
    apply();
  }

  sortNum.addEventListener('click', ()=>toggle(sortNum, sortAZ));
  sortAZ.addEventListener('click', ()=>toggle(sortAZ, sortNum));
  q.addEventListener('input', apply);

  // Build data
  let items = [];

  // Prefer recipes_index.json (title + file). Fallback to parsing <noscript> list.
  fetch('recipes_index.json')
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(data => {
      // data = [{title: "Pico de Gallo", file: "001-pico-de-gallo.html"}, ...]
      items = data.map(d => ({
        title: d.title,
        num: numFromFile(d.file),
        href: 'exports/html/' + d.file
      }));
      apply();
    })
    .catch(() => {
      // Fallback: parse noscript list and prettify slugs
      const ns = document.querySelector('noscript');
      const t = document.createElement('div');
      t.innerHTML = ns ? ns.textContent || ns.innerHTML : "";
      const links = Array.from(t.querySelectorAll('a'));

      items = links.map(a=>{
        const href = a.getAttribute('href');
        const file = (href.split('/').pop()||'').trim();
        const base = file.replace(/\.html$/,'');
        const num = numFromFile(base);
        const slug = base.replace(/^\d{3}-/,'').replace(/-/g,' ');
        const pretty = slug.replace(/\b\w/g, ch=>ch.toUpperCase()).replace(/\b(And|Or|Of|In|On|With|For|To|By|From)\b/g, s=>s.toLowerCase());
        return { title: pretty, num, href };
      });
      apply();
    });
})();
</script>
