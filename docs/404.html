<script>
(function () {
  const app = document.getElementById('app');
  if (!location.pathname.includes('/arabiyya/')) {
    app.innerHTML = '<h1>Page not found</h1><p><a href="/">Go to homepage</a></p>';
    return;
  }

  // UI
  app.innerHTML = `
    <h1>We couldn’t open that recipe page</h1>
    <p class="muted">Try searching for the recipe by name.</p>
    <input id="q" type="search" placeholder="Search recipes…" autofocus>
    <ul id="results"></ul>
    <a class="btn" href="/arabiyya/">Browse full index →</a>
  `;

  const q = document.getElementById('q');
  const results = document.getElementById('results');

  // replicate your exporter’s filename rule: use title_en (fallback title_rom), replace "/" with "-", keep up to 80 chars
  function fileFromTitle(r) {
    const title = (r.title_en || r.title_rom || 'Recipe');
    const safe  = title.slice(0, 80).replace(/\//g, '-');
    return encodeURIComponent(safe + '.html'); // URL-safe
  }

  function score(a,b){
    a=a.toLowerCase(); b=b.toLowerCase();
    if (a===b) return 1e6;
    if (a.includes(b)) return 1e5;
    const A=new Set(a.split(/[^a-z0-9’'–-]+/).filter(Boolean));
    const B=new Set(b.split(/[^a-z0-9’'–-]+/).filter(Boolean));
    let hit=0; B.forEach(t=>{ if(A.has(t)) hit++; });
    return hit*100 - Math.abs(a.length-b.length);
  }

  function render(list){
    results.innerHTML = list.map(r => {
      const href = '/arabiyya/exports/html/' + fileFromTitle(r);
      const title = r.title_en || r.title_rom;
      return `<li><a href="${href}">${title}</a></li>`;
    }).join('') || '<li class="muted">No matches yet — try a different word.</li>';
  }

  // ✅ Use YOUR existing JSON (doc, anchor, title_en, title_rom, title_ar)
  fetch('/arabiyya/recipes_index.json')
    .then(r => r.json())
    .then(data => {
      // seed suggestions
      render(data.slice(0,10));
      q.addEventListener('input', () => {
        const v = q.value.trim();
        if (!v) { render(data.slice(0,10)); return; }
        const ranked = data
          .map(r => ({...r, _s: score(r.title_en || r.title_rom, v)}))
          .sort((a,b) => b._s - a._s)
          .slice(0,12);
        render(ranked);
      });
    })
    .catch(() => { results.innerHTML = '<li class="muted">Couldn’t load recipe list. <a href="/arabiyya/">Open the index</a>.</li>'; });
})();
</script>
